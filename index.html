<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSI JSON Prompt Builder</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; opacity: .8; }
    input, button, select, textarea { padding: 10px; font-size: 14px; }
    input { min-width: 260px; }
    button { cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .muted { opacity: .7; font-size: 13px; }
    .list { max-height: 240px; overflow: auto; border: 1px solid #eee; border-radius: 10px; padding: 8px; }
    .asin-item { padding: 8px; border-radius: 8px; display: flex; justify-content: space-between; gap: 10px; }
    .asin-item:hover { background: #f6f6f6; }
    .asin-item.active { background: #e9f3ff; border: 1px solid #b8d7ff; }
    pre { background: #0b1020; color: #dce7ff; padding: 12px; border-radius: 10px; overflow: auto; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .ok { color: #0a7a2f; }
    .err { color: #b00020; }
    .small { font-size: 12px; opacity: .8; }
    .navbtn { min-width: 92px; }
  </style>
</head>
<body>
  <h2>CSI JSON Prompt Builder</h2>
  <div class="muted">Load a data*.json, search an ASIN, then copy a ready-to-use prompt.</div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label>Primary rule (saved)</label>
        <input id="primaryRule" placeholder="e.g. FR_Textile_... or FR_Sport_..." />
      </div>

      <div class="field">
        <label>Data name (saved)</label>
        <input id="dataName" placeholder="e.g. data1" />
      </div>

      <div class="actions">
        <button id="btnLoad">Load Data</button>
        <label class="field" style="margin:0;">
          <span class="small">or choose JSON file</span>
          <input id="fileInput" type="file" accept=".json,application/json" />
        </label>
      </div>
    </div>

    <div id="loadStatus" class="small" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label>Search ASIN</label>
        <input id="asinInput" placeholder="e.g. B0D7HY2VS4" />
      </div>

      <div class="actions">
        <button id="btnConfirm">Confirm</button>

        <button id="btnPrev" class="navbtn" disabled>Prev</button>
        <button id="btnNext" class="navbtn" disabled>Next</button>

        <button id="btnCopy" disabled>Copy Prompt</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div style="flex:1; min-width: 320px;">
        <div class="muted">ASIN list (in file order)</div>
        <div class="list" id="asinList"></div>
      </div>
      <div style="flex:2; min-width: 360px;">
        <div class="muted">Selected record JSON</div>
        <pre id="jsonView">{}</pre>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS_PRIMARY = "csi_ui_primary_rule";
  const LS_DATA    = "csi_ui_data_name";

  const $primary = document.getElementById("primaryRule");
  const $dataName = document.getElementById("dataName");
  const $btnLoad = document.getElementById("btnLoad");
  const $fileInput = document.getElementById("fileInput");
  const $loadStatus = document.getElementById("loadStatus");

  const $asinInput = document.getElementById("asinInput");
  const $btnConfirm = document.getElementById("btnConfirm");
  const $btnPrev = document.getElementById("btnPrev");
  const $btnNext = document.getElementById("btnNext");
  const $btnCopy = document.getElementById("btnCopy");
  const $asinList = document.getElementById("asinList");
  const $jsonView = document.getElementById("jsonView");

  let currentData = null;       // whole file JSON
  let currentRecords = [];      // records array (in order)
  let selectedRecord = null;
  let selectedIndex = -1;

  // Restore saved inputs
  $primary.value = localStorage.getItem(LS_PRIMARY) || "";
  $dataName.value = localStorage.getItem(LS_DATA) || "";

  // Persist on change
  $primary.addEventListener("input", () => localStorage.setItem(LS_PRIMARY, $primary.value));
  $dataName.addEventListener("input", () => localStorage.setItem(LS_DATA, $dataName.value));

  function setStatus(msg, kind="") {
    $loadStatus.className = "small " + (kind === "ok" ? "ok" : kind === "err" ? "err" : "");
    $loadStatus.textContent = msg;
  }

  function updateNavButtons() {
    const hasSel = selectedIndex >= 0 && selectedIndex < currentRecords.length;
    $btnPrev.disabled = !(hasSel && selectedIndex > 0);
    $btnNext.disabled = !(hasSel && selectedIndex < currentRecords.length - 1);
  }

  function renderAsinList() {
    $asinList.innerHTML = "";
    if (!currentRecords.length) {
      $asinList.innerHTML = `<div class="muted">No records loaded.</div>`;
      return;
    }
    currentRecords.forEach((r, idx) => {
      const div = document.createElement("div");
      const active = (idx === selectedIndex);
      div.className = "asin-item" + (active ? " active" : "");
      div.innerHTML = `<div><b>${idx + 1}.</b> ${r.asin}</div><div class="small muted">${(r.csi_status || "")}</div>`;
      div.addEventListener("click", () => {
        selectByIndex(idx, true);
      });
      $asinList.appendChild(div);
    });
  }

  function pretty(obj) {
    return JSON.stringify(obj, null, 2);
  }

  function selectByIndex(idx, scrollIntoView=false) {
    if (idx < 0 || idx >= currentRecords.length) return;
    selectedIndex = idx;
    selectedRecord = currentRecords[idx];

    $asinInput.value = selectedRecord.asin || "";
    $jsonView.textContent = pretty(selectedRecord);
    $btnCopy.disabled = false;

    updateNavButtons();
    renderAsinList();

    if (scrollIntoView) {
      // best-effort scroll: find active element
      const nodes = $asinList.querySelectorAll(".asin-item");
      const el = nodes[idx];
      if (el) el.scrollIntoView({ block: "nearest" });
    }

    setStatus(`Selected ASIN #${idx + 1}: ${selectedRecord.asin}`, "ok");
  }

  function selectRecordByAsin(asinRaw) {
    const asin = (asinRaw || "").trim().toUpperCase();
    const idx = currentRecords.findIndex(x => (x.asin || "").toUpperCase() === asin);
    if (idx === -1) return false;
    selectByIndex(idx, true);
    return true;
  }

  async function loadByDataName() {
    const name = ($dataName.value || "").trim();
    if (!name) {
      setStatus("Please input a data name, e.g. data1", "err");
      return;
    }

    // Default: data1 -> ./data1.json
    // If your JSONs are in a folder, change to: `./out_json/${name}.json`
    // ✅ 正确：指向 out_json 目录
const url = `./out_json/${name}.json`;


    try {
      setStatus(`Loading: ${url} ...`);
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const json = await res.json();
      applyLoadedJson(json, `${name}.json`);
      setStatus(`Loaded ${name}.json successfully. records=${currentRecords.length}`, "ok");
    } catch (e) {
      setStatus(`Failed to load by name. (${e.message}) Try "Choose JSON file" or run a local server.`, "err");
      currentData = null;
      currentRecords = [];
      selectedRecord = null;
      selectedIndex = -1;
      renderAsinList();
      $jsonView.textContent = "{}";
      $btnCopy.disabled = true;
      updateNavButtons();
    }
  }

  function applyLoadedJson(json, filenameHint="") {
    currentData = json;

    if (Array.isArray(json)) {
      currentRecords = json;
    } else if (json && Array.isArray(json.records)) {
      currentRecords = json.records;
    } else {
      currentRecords = [];
    }

    // reset selection
    selectedRecord = null;
    selectedIndex = -1;
    $btnCopy.disabled = true;
    $jsonView.textContent = "{}";
    updateNavButtons();

    const sf = (json && json.source_file) ? json.source_file : filenameHint;
    setStatus(`Loaded source: ${sf}. records=${currentRecords.length}`, "ok");

    renderAsinList();
  }

  // Load button
  $btnLoad.addEventListener("click", loadByDataName);

  // File input loader
  $fileInput.addEventListener("change", async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    try {
      const text = await f.text();
      const json = JSON.parse(text);
      applyLoadedJson(json, f.name);

      // If user picked data1.json, auto-fill dataName = data1
      const base = f.name.replace(/\.json$/i, "");
      if (base) {
        $dataName.value = base;
        localStorage.setItem(LS_DATA, base);
      }
      setStatus(`Loaded file: ${f.name}. records=${currentRecords.length}`, "ok");
    } catch (e) {
      setStatus(`Failed to parse JSON file: ${e.message}`, "err");
    } finally {
      $fileInput.value = "";
    }
  });

  // Confirm search
  $btnConfirm.addEventListener("click", () => {
    if (!currentRecords.length) {
      setStatus("No data loaded yet. Load by data name or choose a JSON file first.", "err");
      return;
    }
    const asin = ($asinInput.value || "").trim();
    if (!asin) {
      setStatus("Please input an ASIN.", "err");
      return;
    }
    const ok = selectRecordByAsin(asin);
    if (!ok) {
      setStatus(`ASIN not found in current file: ${asin}`, "err");
      selectedRecord = null;
      selectedIndex = -1;
      $btnCopy.disabled = true;
      $jsonView.textContent = "{}";
      updateNavButtons();
      renderAsinList();
    }
  });

  // Prev/Next
  $btnPrev.addEventListener("click", () => {
    if (selectedIndex > 0) selectByIndex(selectedIndex - 1, true);
  });

  $btnNext.addEventListener("click", () => {
    if (selectedIndex >= 0 && selectedIndex < currentRecords.length - 1) {
      selectByIndex(selectedIndex + 1, true);
    }
  });

  // Copy prompt
  $btnCopy.addEventListener("click", async () => {
    if (!selectedRecord) return;
    const rule = ($primary.value || "").trim() || "{primary rule}";

    const prompt =
`Base on what you know about the shoes in EPR FR, please help me check the is the ASIN below to check is it belong to ${rule} or not(if not tell which should this belong to and why):
${JSON.stringify(selectedRecord, null, 2)}`;

    try {
      await navigator.clipboard.writeText(prompt);
      setStatus("Prompt copied to clipboard ✅", "ok");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = prompt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      setStatus("Prompt copied (fallback) ✅", "ok");
    }
  });

  // Initial render
  renderAsinList();
  updateNavButtons();
})();
</script>
</body>
</html>

