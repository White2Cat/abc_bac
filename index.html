<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSI JSON Prompt Builder</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; opacity: .8; }
    input, button { padding: 10px; font-size: 14px; }
    input { min-width: 260px; }
    button { cursor: pointer; }
    button[disabled]{ opacity:.55; cursor:not-allowed; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .muted { opacity: .7; font-size: 13px; }
    .list { max-height: 260px; overflow: auto; border: 1px solid #eee; border-radius: 10px; padding: 8px; }
    .asin-item { padding: 8px; border-radius: 8px; display: flex; justify-content: space-between; gap: 10px; align-items:center; }
    .asin-item:hover { background: #f6f6f6; }
    .asin-item.active { background: #e9f3ff; border: 1px solid #b8d7ff; }
    pre { background: #0b1020; color: #dce7ff; padding: 12px; border-radius: 10px; overflow: auto; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .ok { color: #0a7a2f; }
    .err { color: #b00020; }
    .small { font-size: 12px; opacity: .8; }
    .navbtn { min-width: 92px; }
    .chip {
      display:inline-block; padding:4px 8px; border:1px solid #eee; border-radius:999px;
      margin:4px 6px 0 0; font-size:12px; background:#fff;
    }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap: 6px 10px; margin-top: 8px; }
    .dpimg { max-width:160px; border-radius:10px; border:1px solid #eee; }
    .two-col { display:flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 320px; }
    .badge {
      font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #eee; background:#fff;
      min-width: 40px; text-align:center;
    }
    .badge.tp { border-color:#9ad5ae; background:#eaf7ef; }
    .badge.fp { border-color:#ffb7b7; background:#ffecec; }
    .btn-mini { padding: 8px 10px; font-size: 13px; }
  </style>
</head>
<body>
  <h2>CSI JSON Prompt Builder</h2>
  <div class="muted">Load a data*.json, search an ASIN, then copy a ready-to-use prompt. Mark TP/FP and export CSV before leaving.</div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label>Primary rule (saved)</label>
        <input id="primaryRule" placeholder="" />
      </div>

      <div class="field">
        <label>Data name (saved)</label>
        <input id="dataName" placeholder="" />
      </div>

      <div class="actions">
        <button id="btnLoad">Load Data</button>
        <label class="field" style="margin:0;">
          <span class="small">or choose JSON file</span>
          <input id="fileInput" type="file" accept=".json,application/json" />
        </label>
      </div>
    </div>

    <div id="loadStatus" class="small" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label>Search ASIN</label>
        <input id="asinInput" placeholder="e.g. B0D7HY2VS4" />
      </div>

      <div class="actions">
        <button id="btnConfirm">Confirm</button>
        <button id="btnPrev" class="navbtn" disabled>Prev</button>
        <button id="btnNext" class="navbtn" disabled>Next</button>

        <button id="btnCopy" disabled>Copy Prompt</button>

        <span style="width:1px;height:26px;background:#ddd;display:inline-block;margin:0 2px;"></span>

        <button id="btnTP" class="btn-mini" disabled>TP</button>
        <button id="btnFP" class="btn-mini" disabled>FP</button>
        <button id="btnClear" class="btn-mini" disabled>Clear</button>
        <span id="decisionText" class="small muted">Decision: -</span>

        <span style="width:1px;height:26px;background:#ddd;display:inline-block;margin:0 2px;"></span>

        <button id="btnExport" class="btn-mini" disabled>Export CSV</button>
      </div>
    </div>

    <div class="two-col" style="margin-top:12px;">
      <div class="col">
        <div class="muted">ASIN list (in file order)</div>
        <div class="list" id="asinList"></div>
      </div>

      <div class="col" style="flex:2; min-width: 360px;">
        <div class="muted">Human-readable (for quick decision)</div>
        <div id="humanView" class="card" style="margin-top:8px;"></div>

        <div class="muted" style="margin-top:12px;">Selected record JSON (for copy/trace)</div>
        <pre id="jsonView">{}</pre>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS_PRIMARY = "csi_ui_primary_rule";
  const LS_DATA    = "csi_ui_data_name";

  // Decisions storage:
  // LS_DECISIONS = { [dataName]: { [asin]: "TP" | "FP" } }
  const LS_DECISIONS = "csi_ui_decisions_map_v1";

  // Export markers:
  // LS_LAST_EXPORT = { [dataName]: timestamp_ms }
  const LS_LAST_EXPORT = "csi_ui_last_export_v1";

  // Dirty markers:
  // LS_DIRTY = { [dataName]: true/false }
  const LS_DIRTY = "csi_ui_dirty_v1";

  const $primary = document.getElementById("primaryRule");
  const $dataName = document.getElementById("dataName");
  const $btnLoad = document.getElementById("btnLoad");
  const $fileInput = document.getElementById("fileInput");
  const $loadStatus = document.getElementById("loadStatus");

  const $asinInput = document.getElementById("asinInput");
  const $btnConfirm = document.getElementById("btnConfirm");
  const $btnPrev = document.getElementById("btnPrev");
  const $btnNext = document.getElementById("btnNext");
  const $btnCopy = document.getElementById("btnCopy");

  const $btnTP = document.getElementById("btnTP");
  const $btnFP = document.getElementById("btnFP");
  const $btnClear = document.getElementById("btnClear");
  const $decisionText = document.getElementById("decisionText");

  const $btnExport = document.getElementById("btnExport");

  const $asinList = document.getElementById("asinList");
  const $jsonView = document.getElementById("jsonView");
  const $humanView = document.getElementById("humanView");

  let currentData = null;
  let currentRecords = [];
  let selectedRecord = null;
  let selectedIndex = -1;
  let currentDataKey = ""; // data name used for saving decisions

  // ---------- localStorage helpers ----------
  function loadJsonLS(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch {
      return fallback;
    }
  }
  function saveJsonLS(key, val) {
    localStorage.setItem(key, JSON.stringify(val));
  }

  function getDecisionsMap() {
    return loadJsonLS(LS_DECISIONS, {});
  }
  function setDecision(dataKey, asin, decisionOrNull) {
    if (!dataKey || !asin) return;

    const map = getDecisionsMap();
    map[dataKey] = map[dataKey] || {};

    if (!decisionOrNull) {
      delete map[dataKey][asin];
    } else {
      map[dataKey][asin] = decisionOrNull;
    }
    saveJsonLS(LS_DECISIONS, map);

    // mark dirty
    const dirty = loadJsonLS(LS_DIRTY, {});
    dirty[dataKey] = true;
    saveJsonLS(LS_DIRTY, dirty);
  }
  function getDecision(dataKey, asin) {
    const map = getDecisionsMap();
    return (map[dataKey] && map[dataKey][asin]) ? map[dataKey][asin] : "";
  }
  function isDirty(dataKey) {
    const dirty = loadJsonLS(LS_DIRTY, {});
    return !!dirty[dataKey];
  }
  function clearDirty(dataKey) {
    const dirty = loadJsonLS(LS_DIRTY, {});
    dirty[dataKey] = false;
    saveJsonLS(LS_DIRTY, dirty);
  }

  // ---------- UI helpers ----------
  // Restore saved inputs
  $primary.value = localStorage.getItem(LS_PRIMARY) || "";
  $dataName.value = localStorage.getItem(LS_DATA) || "";

  $primary.addEventListener("input", () => localStorage.setItem(LS_PRIMARY, $primary.value));
  $dataName.addEventListener("input", () => localStorage.setItem(LS_DATA, $dataName.value));

  function setStatus(msg, kind="") {
    $loadStatus.className = "small " + (kind === "ok" ? "ok" : kind === "err" ? "err" : "");
    $loadStatus.textContent = msg;
  }

  function pretty(obj) {
    return JSON.stringify(obj, null, 2);
  }

  function updateNavButtons() {
    const hasSel = selectedIndex >= 0 && selectedIndex < currentRecords.length;
    $btnPrev.disabled = !(hasSel && selectedIndex > 0);
    $btnNext.disabled = !(hasSel && selectedIndex < currentRecords.length - 1);
  }

  function updateDecisionUI() {
    const hasSel = !!selectedRecord && !!currentDataKey;
    const asin = hasSel ? (selectedRecord.asin || "") : "";
    const d = hasSel ? getDecision(currentDataKey, asin) : "";

    $btnTP.disabled = !hasSel;
    $btnFP.disabled = !hasSel;
    $btnClear.disabled = !hasSel;
    $btnExport.disabled = !currentDataKey || !currentRecords.length;

    $decisionText.textContent = `Decision: ${d || "-"}`;

    // optional: visually indicate active
    $btnTP.style.outline = (d === "TP") ? "2px solid #2e7d32" : "none";
    $btnFP.style.outline = (d === "FP") ? "2px solid #b00020" : "none";
  }

  function renderBadge(decision) {
    if (!decision) return `<span class="badge muted">-</span>`;
    if (decision === "TP") return `<span class="badge tp">TP</span>`;
    if (decision === "FP") return `<span class="badge fp">FP</span>`;
    return `<span class="badge">${decision}</span>`;
  }

  function renderAsinList() {
    $asinList.innerHTML = "";
    if (!currentRecords.length) {
      $asinList.innerHTML = `<div class="muted">No records loaded.</div>`;
      return;
    }
    currentRecords.forEach((r, idx) => {
      const div = document.createElement("div");
      const active = (idx === selectedIndex);
      const asin = r.asin || "";
      const decision = currentDataKey ? getDecision(currentDataKey, asin) : "";

      div.className = "asin-item" + (active ? " active" : "");
      div.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div><b>${idx + 1}.</b></div>
          <div>${asin}</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          ${renderBadge(decision)}
          <div class="small muted">${(r.csi_status || "")}</div>
        </div>
      `;
      div.addEventListener("click", () => selectByIndex(idx, true));
      $asinList.appendChild(div);
    });
  }

  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  function bulletList(arr) {
    if (!arr || !arr.length) return `<div class="muted">None</div>`;
    const top = arr.slice(0, 6);
    return `<ul style="margin:6px 0 0 18px;">
      ${top.map(b => `<li>${esc(b)}</li>`).join("")}
    </ul>`;
  }

  function chip(text) {
    if (!text) return "";
    return `<span class="chip">${esc(text)}</span>`;
  }

  function renderHuman(record) {
    if (!record) return `<div class="muted">No record selected.</div>`;

    const dp = record.dp || {};
    const attrs = record.attributes || {};
    const sizeInfo = attrs.size_info || {};
    const ssz = sizeInfo.structured_size || {};
    const fw = attrs.footwear_size || {};
    const age = attrs.age_range || {};
    const material = attrs.material || {};
    const bullets = attrs.bullet_points || {};

    const frBullets = Array.isArray(bullets.fr) ? bullets.fr : [];
    const enBullets = Array.isArray(bullets.en) ? bullets.en : [];
    const otherBullets = Array.isArray(bullets.other) ? bullets.other : [];

    const imgHtml = dp.image
      ? `<img class="dpimg" src="${esc(dp.image)}" alt="DP image" />`
      : `<div class="muted">No DP image</div>`;

    const linkHtml = dp.fr_dp_url
      ? `<a href="${esc(dp.fr_dp_url)}" target="_blank" rel="noopener">Open FR DP ↗</a>`
      : `<span class="muted">No DP link</span>`;

    const tags =
      chip(age.normalized ? `age: ${age.normalized}` : "") +
      chip(attrs.target_gender ? `target_gender: ${attrs.target_gender}` : "") +
      chip(ssz.gender ? `csi_gender: ${ssz.gender}` : "") +
      chip(ssz.numeric_size ? `EU: ${ssz.numeric_size}` : (sizeInfo.size ? `size: ${sizeInfo.size}` : "")) +
      chip((ssz.width || fw.width) ? `width: ${ssz.width || fw.width}` : "") +
      chip(material.normalized ? `material: ${material.normalized}` : (material.raw ? `material: ${material.raw}` : ""));

    const addSizes = (sizeInfo.additional_sizes_detected || []).join(", ");
    const structuredFacts = [
      ssz.size_system ? `system=${ssz.size_system}` : "",
      ssz.size_class ? `class=${ssz.size_class}` : "",
      ssz.age_group ? `age_group=${ssz.age_group}` : ""
    ].filter(Boolean).join(", ");

    return `
      <div style="display:flex;gap:14px;flex-wrap:wrap;">
        <div style="min-width:180px;">
          ${imgHtml}
          <div style="margin-top:8px;">${linkHtml}</div>
          <div class="small muted" style="margin-top:6px;">ASIN: <b>${esc(record.asin)}</b></div>
        </div>

        <div style="flex:1;min-width:260px;">
          <div style="font-size:16px;font-weight:750;line-height:1.3;">
            ${esc(record.csi_title || "(No CSI title)")}
          </div>
          <div class="small muted" style="margin-top:6px;">
            CSI status: <b>${esc(record.csi_status || "")}</b>
          </div>

          <div style="margin-top:10px;">${tags || `<span class="muted">No key tags</span>`}</div>

          <div style="margin-top:12px;">
            <div class="muted">Quick facts</div>
            <div class="kv small">
              <div><b>Size (display)</b></div><div>${esc(sizeInfo.size || "")}</div>
              <div><b>Size map</b></div><div>${esc(sizeInfo.size_map || "")}</div>
              <div><b>Additional sizes</b></div><div>${esc(addSizes || "")}</div>
              <div><b>Structured size</b></div><div>${esc(structuredFacts || "")}</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="muted">Bullet points (FR)</div>
            ${bulletList(frBullets)}
          </div>

          <div style="margin-top:12px;">
            <div class="muted">Bullet points (EN)</div>
            ${bulletList(enBullets)}
          </div>

          ${otherBullets.length ? `
          <div style="margin-top:12px;">
            <div class="muted">Bullet points (Other)</div>
            ${bulletList(otherBullets)}
          </div>` : ""}
        </div>
      </div>
    `;
  }

  // ---------- selection ----------
  function selectByIndex(idx, scrollIntoView=false) {
    if (idx < 0 || idx >= currentRecords.length) return;

    selectedIndex = idx;
    selectedRecord = currentRecords[idx];

    $asinInput.value = selectedRecord.asin || "";
    $jsonView.textContent = pretty(selectedRecord);
    $humanView.innerHTML = renderHuman(selectedRecord);

    $btnCopy.disabled = false;
    updateNavButtons();
    renderAsinList();
    updateDecisionUI();

    if (scrollIntoView) {
      const nodes = $asinList.querySelectorAll(".asin-item");
      const el = nodes[idx];
      if (el) el.scrollIntoView({ block: "nearest" });
    }

    setStatus(`Selected ASIN #${idx + 1}: ${selectedRecord.asin}`, "ok");
  }

  function selectRecordByAsin(asinRaw) {
    const asin = (asinRaw || "").trim().toUpperCase();
    const idx = currentRecords.findIndex(x => (x.asin || "").toUpperCase() === asin);
    if (idx === -1) return false;
    selectByIndex(idx, true);
    return true;
  }

  // ---------- export ----------
  function exportCsvForCurrentData() {
    if (!currentDataKey || !currentRecords.length) return;

    // CSV header
    const rows = [["data_name", "asin", "decision"]];

    for (const r of currentRecords) {
      const asin = r.asin || "";
      const decision = getDecision(currentDataKey, asin) || "";
      rows.push([currentDataKey, asin, decision]);
    }

    const csv = rows.map(cols => cols.map(v => {
      const s = String(v ?? "");
      // escape quotes
      const escaped = s.replace(/"/g, '""');
      // quote if needed
      return /[",\n]/.test(escaped) ? `"${escaped}"` : escaped;
    }).join(",")).join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const ts = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `${currentDataKey}_tp_fp_${ts}.csv`;

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // mark exported (clear dirty)
    clearDirty(currentDataKey);

    const last = loadJsonLS(LS_LAST_EXPORT, {});
    last[currentDataKey] = Date.now();
    saveJsonLS(LS_LAST_EXPORT, last);

    setStatus(`Exported CSV: ${filename} ✅`, "ok");
    renderAsinList();
    updateDecisionUI();
  }

  // ---------- load/apply ----------
  function applyLoadedJson(json, filenameHint="") {
    currentData = json;

    if (Array.isArray(json)) currentRecords = json;
    else if (json && Array.isArray(json.records)) currentRecords = json.records;
    else currentRecords = [];

    // Determine dataKey:
    // Prefer the input dataName; fallback to file stem (filename without .json)
    let dk = ($dataName.value || "").trim();
    if (!dk && filenameHint) dk = filenameHint.replace(/\.json$/i, "");
    currentDataKey = dk || "data";

    // reset selection
    selectedRecord = null;
    selectedIndex = -1;

    $btnCopy.disabled = true;
    $jsonView.textContent = "{}";
    $humanView.innerHTML = renderHuman(null);

    updateNavButtons();
    renderAsinList();
    updateDecisionUI();

    const sf = (json && json.source_file) ? json.source_file : filenameHint;
    setStatus(`Loaded source: ${sf}. dataKey=${currentDataKey}. records=${currentRecords.length}`, "ok");

    // enable export even before selecting
    $btnExport.disabled = !currentDataKey || !currentRecords.length;
  }

  function maybeWarnDirtyBeforeSwitch() {
    if (!currentDataKey) return true;
    if (!isDirty(currentDataKey)) return true;

    // Offer export now
    const ok = confirm(`You have un-exported TP/FP decisions for "${currentDataKey}".\n\nPress OK to Export CSV now, or Cancel to continue without exporting.`);
    if (ok) exportCsvForCurrentData();
    // allow switching regardless (user chose)
    return true;
  }

  async function loadByDataName() {
    maybeWarnDirtyBeforeSwitch();

    const name = ($dataName.value || "").trim();
    if (!name) {
      setStatus("Please input a data name, e.g. data1", "err");
      return;
    }

    const url = `./out_json/${name}.json`;

    try {
      setStatus(`Loading: ${url} ...`);
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const json = await res.json();
      applyLoadedJson(json, `${name}.json`);
    } catch (e) {
      setStatus(`Failed to load by name. (${e.message}) Try "Choose JSON file".`, "err");
      currentData = null;
      currentRecords = [];
      selectedRecord = null;
      selectedIndex = -1;
      currentDataKey = "";

      renderAsinList();
      $jsonView.textContent = "{}";
      $humanView.innerHTML = renderHuman(null);

      $btnCopy.disabled = true;
      updateNavButtons();
      updateDecisionUI();
      $btnExport.disabled = true;
    }
  }

  // ---------- events ----------
  $btnLoad.addEventListener("click", loadByDataName);

  $fileInput.addEventListener("change", async (ev) => {
    maybeWarnDirtyBeforeSwitch();

    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    try {
      const text = await f.text();
      const json = JSON.parse(text);

      // If user picked data1.json, auto-fill dataName = data1
      const base = f.name.replace(/\.json$/i, "");
      if (base) {
        $dataName.value = base;
        localStorage.setItem(LS_DATA, base);
      }

      applyLoadedJson(json, f.name);
    } catch (e) {
      setStatus(`Failed to parse JSON file: ${e.message}`, "err");
    } finally {
      $fileInput.value = "";
    }
  });

  $btnConfirm.addEventListener("click", () => {
    if (!currentRecords.length) {
      setStatus("No data loaded yet. Load by data name or choose a JSON file first.", "err");
      return;
    }
    const asin = ($asinInput.value || "").trim();
    if (!asin) {
      setStatus("Please input an ASIN.", "err");
      return;
    }
    const ok = selectRecordByAsin(asin);
    if (!ok) {
      setStatus(`ASIN not found in current file: ${asin}`, "err");
      selectedRecord = null;
      selectedIndex = -1;
      $btnCopy.disabled = true;
      $jsonView.textContent = "{}";
      $humanView.innerHTML = renderHuman(null);
      updateNavButtons();
      renderAsinList();
      updateDecisionUI();
    }
  });

  $btnPrev.addEventListener("click", () => {
    if (selectedIndex > 0) selectByIndex(selectedIndex - 1, true);
  });

  $btnNext.addEventListener("click", () => {
    if (selectedIndex >= 0 && selectedIndex < currentRecords.length - 1) {
      selectByIndex(selectedIndex + 1, true);
    }
  });

  $btnCopy.addEventListener("click", async () => {
    if (!selectedRecord) return;
    const rule = ($primary.value || "").trim() || "{primary rule}";

    const prompt =
`Base on what you know about the shoes in EPR FR, please help me check the is the ASIN below to check is it belong to ${rule} or not(if not tell which should this belong to and why):
${JSON.stringify(selectedRecord, null, 2)}`;

    try {
      await navigator.clipboard.writeText(prompt);
      setStatus("Prompt copied to clipboard ✅", "ok");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = prompt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      setStatus("Prompt copied (fallback) ✅", "ok");
    }
  });

  // TP/FP/Clear
  $btnTP.addEventListener("click", () => {
    if (!selectedRecord || !currentDataKey) return;
    setDecision(currentDataKey, selectedRecord.asin, "TP");
    setStatus(`Saved decision TP for ${selectedRecord.asin}`, "ok");
    renderAsinList();
    updateDecisionUI();
  });

  $btnFP.addEventListener("click", () => {
    if (!selectedRecord || !currentDataKey) return;
    setDecision(currentDataKey, selectedRecord.asin, "FP");
    setStatus(`Saved decision FP for ${selectedRecord.asin}`, "ok");
    renderAsinList();
    updateDecisionUI();
  });

  $btnClear.addEventListener("click", () => {
    if (!selectedRecord || !currentDataKey) return;
    setDecision(currentDataKey, selectedRecord.asin, null);
    setStatus(`Cleared decision for ${selectedRecord.asin}`, "ok");
    renderAsinList();
    updateDecisionUI();
  });

  // Export
  $btnExport.addEventListener("click", exportCsvForCurrentData);

  // Warn before close/refresh if dirty
  window.addEventListener("beforeunload", (e) => {
    if (currentDataKey && isDirty(currentDataKey)) {
      e.preventDefault();
      e.returnValue = ""; // required for most browsers
      return "";
    }
  });

  // Initial render
  $humanView.innerHTML = renderHuman(null);
  renderAsinList();
  updateNavButtons();
  updateDecisionUI();
})();
</script>
</body>
</html>
